#include <Arduino.h>
#include <Wire.h>
#include <U8g2lib.h>
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

// OLED 0.42" 72x40 (offset interno 128x64->(13,14))
U8G2_SSD1306_72X40_ER_F_HW_I2C u8g2(U8G2_R0, /* reset=*/U8X8_PIN_NONE);
BLECharacteristic *characteristic;  

void setup() {
  Serial.begin(115200);
  delay(300);
  pinMode(1, OUTPUT);

  // BLOCO DISPLAY
  Wire.begin(5,6);
  u8g2.setI2CAddress(0x3C<<1);
  u8g2.begin();

  // BLOCO BT
  BLEDevice::init("ESP32C3_IC");
  BLEServer *server = BLEDevice::createServer();
  BLEService *service = server->createService("ABCD"); // UUID 16-bit do serviço
  characteristic = service->createCharacteristic(
                     "1234", // UUID 16-bit da característica
                     BLECharacteristic::PROPERTY_READ   |
                     BLECharacteristic::PROPERTY_WRITE  |
                     BLECharacteristic::PROPERTY_NOTIFY
                   );
  characteristic->addDescriptor(new BLE2902());
  service->start();
  BLEAdvertising *advertising = BLEDevice::getAdvertising();
  advertising->addServiceUUID("ABCD");
  BLEDevice::startAdvertising();
}

uint8_t freq = 0;

void loop() {
  freq++;
  digitalWrite(1, HIGH);
  delay(freq*100);
  digitalWrite(1, LOW);
  delay(freq*100);

  String txt = "Periodo:\n" + String(freq*200);
  Serial.println(txt);

  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_7x13_tr);
  u8g2.drawStr(2,10,"Periodo:");
  u8g2.drawStr(2,25,String(freq*200).c_str());
  u8g2.sendBuffer();

  // BT
  characteristic->setValue(txt.c_str());
  characteristic->notify();
}
