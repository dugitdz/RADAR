#include <Arduino.h>
#include <stdint.h>
float leitor_bytes_phase(uint8_t *aux);

void setup() {
  Serial.begin(1382400);
  Serial1.begin(1382400,SERIAL_8N1,21,20);
  Serial1.setTimeout(60);
  Serial.println("tempo,total_phase,breath_phase,heart_phase,dist");
}

uint8_t prox_byte = 0;
static uint8_t buffer[32];
int len = 0;
float heart_phase,total_phase,breath_phase,dist;
static unsigned long t_phase=0,t_dist=0;
static bool b_phase=false, b_dist=false;
static const unsigned long MAX_dt = 100;

void loop() {
  while (Serial1.available()) {
    uint8_t s = Serial1.read();
    if(s == 0x0A){
      if (Serial1.readBytes(&prox_byte, 1) != 1) continue;
      switch (prox_byte)
      {
      case 0x13:
        len = 14;
        if (len > (int)sizeof(buffer)) break;
        buffer[0] = prox_byte;
        {
          size_t tam = Serial1.readBytes(&buffer[1], len - 1);
          if(tam!=len-1) break;
        }
        t_phase = millis();
        total_phase = leitor_bytes_phase(&buffer[2]);
        breath_phase = leitor_bytes_phase(&buffer[6]);
        heart_phase = leitor_bytes_phase(&buffer[10]);
        b_phase = true;
        if (b_dist) {
          unsigned long dt = (t_phase > t_dist) ? (t_phase - t_dist) : (t_dist - t_phase);
          if (dt <= MAX_dt) {
            unsigned long t_out = (t_phase > t_dist) ? t_phase : t_dist;
            Serial.print(t_out); Serial.print(",");
            Serial.print(total_phase); Serial.print(",");
            Serial.print(breath_phase); Serial.print(",");
            Serial.print(heart_phase); Serial.print(",");
            Serial.println(dist);
            b_dist = false;
            b_phase = false;
          }
        }
        break;

      case 0x16:
        len = 10;
        if (len > (int)sizeof(buffer)) break;
        buffer[0] = prox_byte;
        {
          size_t tam = Serial1.readBytes(&buffer[1], len - 1);
          if(tam!=len-1) break;
        }
        t_dist = millis();
        dist = leitor_bytes_phase(&buffer[6]);
        b_dist = true;
        if (b_phase) {
          unsigned long dt = (t_phase > t_dist) ? (t_phase - t_dist) : (t_dist - t_phase);
          if (dt <= MAX_dt) {
            unsigned long t_out = (t_phase > t_dist) ? t_phase : t_dist;
            Serial.print(t_out); Serial.print(",");
            Serial.print(total_phase); Serial.print(",");
            Serial.print(breath_phase); Serial.print(",");
            Serial.print(heart_phase); Serial.print(",");
            Serial.println(dist);
            b_dist = false;
            b_phase = false;
          }
        }
        break;

      case 0x14:
      default:
        break;
      }
    }
  }
}

float leitor_bytes_phase(uint8_t *aux)
{
  uint32_t u = (uint32_t)aux[0] | ((uint32_t)aux[1] << 8) | ((uint32_t)aux[2] << 16) | ((uint32_t)aux[3] << 24);
  float f;
  memcpy(&f, &u, 4);
  return f;
}
